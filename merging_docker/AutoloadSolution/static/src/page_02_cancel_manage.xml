<?xml version="1.0" encoding="UTF-8" ?>
<templates xml:space="preserve">
    <t t-name="AutoloadSolution.Page02CancelManage">
        <div class="cancel-manage-container" style="height: 100vh; display: flex; flex-direction: column; overflow: hidden;">
            <!-- 상단 헤더 영역 (고정) -->
            <div class="bg-white border-bottom border-gray-200" style="flex-shrink: 0; z-index: 10;">
                <div class="container-fluid px-4 py-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-4">
                            <div class="d-flex align-items-center gap-3">
                                <i class="fa fa-file-text text-primary" style="font-size: 1.5rem;"></i>
                                <div>
                                    <h1 class="h5 fw-semibold text-dark mb-1">말소 관리</h1>
                                    <p class="text-sm text-muted mb-0">말소 신청서 현황을 조회, 관리할 수 있습니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 스크롤 가능한 컨텐츠 영역 -->
            <div class="flex-grow-1 py-4" style="overflow-y: auto;">
                <div class="container-fluid px-3 px-md-4 px-lg-5" style="max-width: 1400px; margin: 0 auto; padding-bottom: 2rem;">
                    <!-- 상단 통계 요약 -->
                    <div class="mb-4 mb-md-6 row g-3">
                        <div class="col-6 col-md-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <p class="text-xs text-muted mb-1">전체 말소</p>
                                            <p class="h4 h-md-3 fw-bold mb-0 text-dark"><t t-esc="data.length"/></p>
                                        </div>
                                        <i class="fa fa-file-text text-primary" style="font-size: 1.5rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <p class="text-xs text-muted mb-1">완료</p>
                                            <p class="h4 h-md-3 fw-bold mb-0" style="color: #22c55e;"> <t t-esc="data.filter(item => item.status === '✅').length"/> </p>
                                        </div>
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:24px;height:24px;background:#d1fadf;">
                                            <div style="width:12px;height:12px;background:#22c55e;border-radius:50%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <p class="text-xs text-muted mb-1">진행중</p>
                                            <p class="h4 h-md-3 fw-bold mb-0" style="color: #2563eb;"> <t t-esc="data.filter(item => item.status === '진행중').length"/> </p>
                                        </div>
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:24px;height:24px;background:#dbeafe;">
                                            <div style="width:12px;height:12px;background:#2563eb;border-radius:50%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <p class="text-xs text-muted mb-1">대기</p>
                                            <p class="h4 h-md-3 fw-bold mb-0" style="color: #eab308;"> <t t-esc="data.filter(item => item.status === '❌').length"/> </p>
                                        </div>
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:24px;height:24px;background:#fef9c3;">
                                            <div style="width:12px;height:12px;background:#eab308;border-radius:50%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <!-- 왼쪽: 검색 필터 (3/12 너비) -->
                        <div class="col-12 col-lg-3">
                            <div class="card shadow-lg">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0 d-flex align-items-center gap-2 text-white">
                                        <i class="fa fa-search"></i>
                                        말소 데이터 검색
                                    </h5>
                                    <p class="text-sm mb-0" style="color: #e0e7ff;">조건을 설정하여 말소 데이터를 필터링하세요.</p>
                                </div>
                                <div class="card-body p-4">
                                    <!-- 기준일자 -->
                                    <div class="mb-3">
                                        <label class="form-label text-sm fw-medium d-flex align-items-center gap-2 mb-2">
                                            기준일자
                                        </label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <label for="dateFrom" class="form-label text-xs text-muted">시작일</label>
                                                <input 
                                                    type="date" 
                                                    class="form-control form-control-sm" 
                                                    id="dateFrom"
                                                    t-att-value="state.dateFrom"
                                                    t-on-input="(ev) => this.handleInputChange('dateFrom', ev.target.value)"
                                                />
                                            </div>
                                            <div class="col-6">
                                                <label for="dateTo" class="form-label text-xs text-muted">종료일</label>
                                                <input 
                                                    type="date" 
                                                    class="form-control form-control-sm" 
                                                    id="dateTo"
                                                    t-att-value="state.dateTo"
                                                    t-on-input="(ev) => this.handleInputChange('dateTo', ev.target.value)"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 상태별 -->
                                    <div class="mb-3">
                                        <label class="form-label text-sm fw-medium d-flex align-items-center gap-2 mb-2">
                                            상태별
                                        </label>
                                        <select 
                                            class="form-select form-select-sm" 
                                            t-att-value="state.status"
                                            t-on-change="(ev) => this.handleInputChange('status', ev.target.value)"
                                        >
                                            <option value="">전체 상태</option>
                                            <option value="✅">완료</option>
                                            <option value="❌">대기</option>
                                        </select>
                                    </div>
                                    <!-- 소유자명 검색 -->
                                    <div class="mb-3">
                                        <label for="ownerName" class="form-label text-sm fw-medium mb-2">
                                            소유자명 검색
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control form-control-sm" 
                                            id="ownerName"
                                            placeholder="소유자명을 입력하세요"
                                            t-att-value="state.ownerName"
                                            t-on-input="(ev) => this.handleInputChange('ownerName', ev.target.value)"
                                        />
                                    </div>
                                    <!-- 차대번호 검색 -->
                                    <div class="mb-3">
                                        <label for="vehicleId" class="form-label text-sm fw-medium mb-2">
                                            차대번호 검색
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control form-control-sm" 
                                            id="vehicleId"
                                            placeholder="차대번호를 입력하세요"
                                            t-att-value="state.vehicleId"
                                            t-on-input="(ev) => this.handleInputChange('vehicleId', ev.target.value)"
                                        />
                                    </div>
                                    <!-- 자동차등록번호 검색 -->
                                    <div class="mb-3">
                                        <label for="registrationNo" class="form-label text-sm fw-medium mb-2">
                                            자동차등록번호 검색
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control form-control-sm" 
                                            id="registrationNo"
                                            placeholder="등록번호를 입력하세요"
                                            t-att-value="state.registrationNo"
                                            t-on-input="(ev) => this.handleInputChange('registrationNo', ev.target.value)"
                                        />
                                    </div>
                                    <button 
                                        type="button" 
                                        class="btn btn-primary btn-sm w-100" 
                                        t-on-click="handleReset"
                                    >
                                        <i class="fa fa-refresh me-2"></i>
                                        초기화
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-info btn-sm w-100 mt-2" 
                                        t-on-click="debugLocalStorage"
                                    >
                                        <i class="fa fa-database me-2"></i>
                                        데이터 확인
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 오른쪽: 전체 말소 현황 (9/12 너비) -->
                        <div class="col-12 col-lg-9">
                            <div class="card shadow-lg h-100">
                                <div class="card-header bg-primary text-white">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="fa fa-database"></i>
                                            말소 현황
                                        </div>
                                        <span class="badge" style="background-color: #e0e7ff; color: #2563eb;">
                                            <t t-esc="sortedData.length"/>건 / 전체 <t t-esc="data.length"/>건
                                        </span>
                                    </div>
                                    <p class="text-sm mb-0" style="color: #e0e7ff;">
                                        <t t-if="filteredData.length === data.length">
                                            전체 말소 데이터를 정렬하여 확인할 수 있습니다.
                                        </t>
                                        <t t-else="">
                                            필터링된 말소 데이터를 확인할 수 있습니다.
                                        </t>
                                    </p>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 60vh; width: 100%; border-radius: 0.375rem;">
                                        <table class="table table-hover mb-0" style="min-width: 1400px; white-space: nowrap; font-size: 0.75rem;">
                                            <thead class="table-light sticky-top" style="position: sticky; top: 0; z-index: 1020; background-color: #f8f9fa;">
                                                <tr>
                                                    <th style="min-width: 120px; width: 120px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('owner_name')"
                                                        >
                                                            <span class="d-none d-md-inline">소유자명</span>
                                                            <span class="d-inline d-md-none">소유자</span>
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 140px; width: 140px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('ssn')"
                                                        >
                                                            <span class="d-none d-lg-inline">주민등록번호</span>
                                                            <span class="d-inline d-lg-none">주민번호</span>
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 200px; width: 200px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('address')"
                                                        >
                                                            주소
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 150px; width: 150px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('email')"
                                                        >
                                                            이메일
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 140px; width: 140px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('phone_number')"
                                                        >
                                                            전화번호
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 140px; width: 140px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('registration_no')"
                                                        >
                                                            자동차등록번호
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 120px; width: 120px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('vehicle_id')"
                                                        >
                                                            차대번호
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 100px; width: 100px;">
                                                        <button 
                                                            type="button" 
                                                            class="btn btn-link btn-sm p-0 fw-medium text-primary" 
                                                            t-on-click="() => this.handleSort('mileage')"
                                                        >
                                                            주행거리
                                                            <i class="fa fa-sort ms-1"></i>
                                                        </button>
                                                    </th>
                                                    <th style="min-width: 120px; width: 120px;">발급상태</th>
                                                    <th style="min-width: 120px; width: 120px;" class="text-center">인보이스 발급</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-if="sortedData.length === 0">
                                                    <tr>
                                                        <td colspan="9" class="text-center py-4 text-muted">
                                                            검색 조건에 맞는 데이터가 없습니다.
                                                        </td>
                                                    </tr>
                                                </t>
                                                <t t-else="">
                                                    <t t-foreach="sortedData" t-as="item" t-key="item.vehicle_id">
                                                        <tr>
                                                            <td class="text-ellipsis" style="min-width: 120px; width: 120px; max-width: 120px;"><t t-esc="item.owner_name"/></td>
                                                            <td class="text-sm text-ellipsis" style="min-width: 140px; width: 140px; max-width: 140px;"><t t-esc="item.ssn"/></td>
                                                            <td class="text-ellipsis d-none d-lg-table-cell" style="min-width: 200px; width: 200px; max-width: 200px;"><t t-esc="item.address"/></td>
                                                            <td class="text-ellipsis d-none d-md-table-cell" style="min-width: 150px; width: 150px; max-width: 150px;"><t t-esc="item.email"/></td>
                                                            <td class="text-ellipsis d-none d-lg-table-cell" style="min-width: 140px; width: 140px; max-width: 140px;"><t t-esc="item.phone_number"/></td>
                                                            <td class="fw-medium text-ellipsis" style="min-width: 140px; width: 140px; max-width: 140px;"><t t-esc="item.registration_no"/></td>
                                                            <td class="fw-medium text-ellipsis" style="min-width: 120px; width: 120px; max-width: 120px; font-family: monospace;"><t t-esc="item.vehicle_id"/></td>
                                                            <td class="text-ellipsis" style="min-width: 100px; width: 100px; max-width: 100px;"><t t-esc="item.mileage"/> km</td>
                                                            <td class="text-ellipsis" style="min-width: 120px; width: 120px; max-width: 120px;">
                                                                <t t-if="item.status === '✅'">
                                                                    <span class="d-inline-flex align-items-center gap-2 px-2 py-1 rounded-pill" style="background:#d1fadf;color:#166534;font-weight:600;font-size:0.875rem;">
                                                                        <i class="fa fa-check-circle" style="color:#22c55e;"></i>
                                                                        발급완료
                                                                    </span>
                                                                </t>
                                                                <t t-elif="item.status === '❌'">
                                                                    <span class="d-inline-flex align-items-center gap-2 px-2 py-1 rounded-pill" style="background:#fef2f2;color:#991b1b;font-weight:600;font-size:0.875rem;">
                                                                        <i class="fa fa-clock-o" style="color:#dc2626;"></i>
                                                                        발급이전
                                                                    </span>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="d-inline-flex align-items-center gap-2 px-2 py-1 rounded-pill" style="background:#f3f4f6;color:#374151;font-weight:600;font-size:0.875rem;">
                                                                        <i class="fa fa-question-circle" style="color:#6b7280;"></i>
                                                                        <t t-esc="item.status"/>
                                                                    </span>
                                                                </t>
                                                            </td>
                                                            <td class="text-center" style="min-width: 100px; width: 100px; max-width: 100px;">
                                                                <button 
                                                                    type="button" 
                                                                    class="btn btn-outline-primary btn-sm" 
                                                                    t-on-click="() => this.handleIssueInvoice(item)"
                                                                    t-att-disabled="state.isProcessing"
                                                                >
                                                                    <i class="fa fa-file-text me-1"></i>
                                                                    <span class="d-none d-md-inline">
                                                                        <t t-if="state.isProcessing">처리중...</t>
                                                                        <t t-else="">인보이스 발급</t>
                                                                    </span>
                                                                    <span class="d-inline d-md-none">
                                                                        <t t-if="state.isProcessing">처리중</t>
                                                                        <t t-else="">발급</t>
                                                                    </span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates> 